/*
 *  test_set_start_stop_origin.sli
 *
 *  This file is part of NEST
 *
 *  Copyright (C) 2011 by
 *  The NEST Initiative
 *
 *  See the file AUTHORS for details.
 *
 *  Permission is granted to compile and modify
 *  this file for non-commercial use.
 *  See the file LICENSE for details.
 *
 */

/* BeginDocumentation
   Name: testsuite::test_set_start_stop_origin - sli script to test if start, stop and origin are set properly

   Synopsis: (test_set_start_stop_origin) run

   Description:
   For all models having start, stop, and origin parameters, this test checks that
   - default values can be set successfully
   - nodes are created with correct default values
   - nodes can be created with correct default values from the command line
   - parameters can be set via SetStatus

   FirstVersion: December 2011
   Author: Hans E Plesser
 */

/unittest (8831) require
/unittest using

M_WARNING setverbosity

/deviceparams [/start /stop /origin] def
/testvalue 1237. def   % unlikely value

ResetKernel

% build list of all models having at least one of deviceparams
/devmodels [] def
modeldict {
  ; /mod Set
  mod GetDefaults /defs Set
  false deviceparams { defs exch known or } Fold 
  {
    /devmodels devmodels mod append def
  } if
} forall

% First test: check that any model that has one deviceparam has all
{
  ResetKernel
  
  true devmodels
  {
    GetDefaults /defs Set
    true deviceparams { defs exch known and } Fold 
    and
  } Fold
} assert_or_die

% Second test: ensure that no default value is equal to test value
{
  ResetKernel
  
  true devmodels
  {
    GetDefaults /defs Set
    true deviceparams { defs exch get /testvalue neq and } Fold 
    and
  } Fold
} assert_or_die

% Third test: check that default values can be set
{
  ResetKernel

  true
  devmodels
  {
    /model Set
    true    
    deviceparams 
    { 
      /p Set 
      model << p testvalue >> SetDefaults
      model GetDefaults p get
      testvalue eq 
      dup not { (Failed on: ) model cvs join == } if
      and
    } Fold
    and
  } Fold
} assert_or_die

% Fourth test: check that default values are transferred to neurons
{
  ResetKernel

  true
  devmodels
  {
    /model Set
    true    
    deviceparams 
    { 
      /p Set 
      model << p testvalue >> SetDefaults
      model Create p get      
      testvalue eq 
      dup not { (Failed on: ) model cvs join == } if
      and
    } Fold
    and
  } Fold
} assert_or_die

% Fifth test: check that values can be set on construction
{
  ResetKernel

  true
  devmodels
  {
    /model Set
    true    
    deviceparams 
    { 
      /p Set 
      model << p testvalue >> Create p get      
      testvalue eq 
      dup not { (Failed on: ) model cvs join == } if
      and
    } Fold
    and
  } Fold
} assert_or_die

% Sixth test: check that values can be set on node
{
  ResetKernel

  true
  devmodels
  {
    /model Set
    true    
    deviceparams 
    { 
      /p Set 
      model Create /n Set
      n p get testvalue neq
      n << p testvalue >> SetStatus
      n p get testvalue eq 
      and
      dup not { (Failed on: ) model cvs join == } if
      and
    } Fold
    and
  } Fold
} assert_or_die


endusing
